# 机械臂分控

## 个人贡献

该机械臂控制系统中，本人的核心贡献集中在小米CyberGear电机的高级控制算法开发，包括CyberGear_Control.c中的所有控制函数。基础的cybergear.c和cybergear.h文件来源于开源代码，步进电机和舵机控制部分由他人编写，本人专注于解决小米电机精确定位和快速响应的核心技术难题。

主要贡献包括：
- 设计并实现了基于6节点5段的精细化动态PD控制器`MiAngleControl_MultiStage_V3`
- 开发了混合控制模式`Move_and_Hold_Hybrid`，结合运控模式和位置模式的优势
- 实现了同步位置控制函数`CyberGear_MoveTo_Sync_PosMode`和梯形速度规划函数`CyberGear_MoveTo_Trapezoidal_V2`
- 解决了双电机CAN通信和电机ID修改问题

## 代码结构

### 主要模块

**CyberGear_Control.h/c - 高级电机控制模块**

核心控制函数包括：

`MiAngleControl_MultiStage_V3()`是精细化动态PD控制器，采用6节点5段设计，根据角度误差动态调整PID参数。支持带载和空载两套参数配置，通过线性插值实现平滑的参数过渡。带载参数针对负重情况优化，空载参数针对快速响应优化，每段都经过精确调参以达到最佳控制效果。

`Move_and_Hold_Hybrid()`实现混合控制模式，这是解决旋转精度和速度矛盾的关键函数。先使用运控模式快速到达目标位置附近，具有较大阻尼不易震荡；然后切换到位置模式进行精确定位，利用位置模式的高精度特性确保最终位置准确。模式切换前必须停止电机，这是查阅官方文档发现的关键要求。

`CyberGear_MoveTo_Sync_PosMode()`提供同步位置控制，通过持续发送位置指令并轮询反馈实现阻塞式等待。支持位置容差和稳定时间配置，确保电机真正到达并稳定在目标位置。

`CyberGear_MoveTo_Trapezoidal_V2()`实现梯形速度规划，支持独立设置加速和减速距离。根据当前位置动态计算目标速度，实现平滑的速度变化曲线，特别适用于升降电机的精确控制。

**Stepper_and_Gripper.h/c - 执行机构控制模块**

本人贡献的部分：
`Lift_MoveTo_cm()`升降控制函数调用了本人开发的梯形速度规划函数，实现了从步进电机到小米电机的升级改造。该函数处理了单位转换、动态超时计算、负载状态判断等复杂逻辑。

**cybergear.h/c - 底层驱动模块（开源代码）**

本人修改内容：修复了原版`set_CANID_cybergear()`函数的bug，原函数无法正常修改电机ID。通过查阅官方文档和CSDN资料，发现问题在于CAN帧格式配置错误，重写了该函数以支持双电机系统。

### 配置文件

**电机ID配置**：`ROTATION_MOTOR_ID 0x7F`（旋转电机），`LIFT_MOTOR_ID 0x1F`（升降电机）
**增益参数配置**：带载和空载两套完整的6节点PID参数，针对不同工况精确调参
**物理参数配置**：升降电机的线盘直径、减速比、最大行程等机械参数

## 调试问题与解决方案

### 1. 机械臂旋转位置不准确的核心问题

**迭代过程与最终方案**：最初尝试分两段PD参数的运控模式，效果不理想。随后开发了基于线性插值的两段PD控制，效果一般。经过深入研究，开发出基于6节点5段的精细化动态PD控制器，将误差空间细分为5个区间，每个区间独立调参，并分别针对带载和空载工况进行参数优化。这个方案在大部分情况下已经非常稳定，能够实现高精度定位。

但在追求更高速度时发现容易产生稳态误差，纯运控模式无法兼顾速度和精度。于是转向位置模式研究，通过查阅小米CyberGear说明书，开发了`set_position_target_and_speed()`等位置模式封装函数。实测发现纯位置模式末端阻尼太小，会产生长时间震荡，调节时间过长。

尝试了多种位置模式优化方案：分段速度控制试图通过动态调整速度解决震荡，仿步进式控制采用固定步长和间隔旋转，梯形速度规划通过平滑的加减速曲线优化运动过程。虽然这些方案都能实现准确定位，但都无法解决调节时间过长的根本问题。

最终采用的`Move_and_Hold_Hybrid()`混合方案完美解决了这个矛盾：运控模式具有大阻尼特性，快速且稳定地到达目标附近；位置模式具有高精度特性，能够消除最后的位置误差。模式切换的关键在于必须先停止电机再切换，这是查阅官方文档发现的重要细节。

### 2. 双电机CAN通信和电机ID问题

**问题现象**：原计划升降使用步进电机，但发现步进电机工作时产生较大的电源纹波，影响系统稳定性。决定改用小米电机后，需要在同一个CAN总线上控制两个电机，这要求修改其中一个电机的ID。

**解决过程**：使用原版cybergear.c中的`set_CANID_cybergear()`函数修改电机ID时发现无效，电机ID无法改变。通过查阅小米CyberGear官方说明书和CSDN相关技术文章，发现问题出在CAN帧格式配置上。原函数的扩展ID格式和数据帧配置存在错误，导致电机无法正确接收和处理ID修改指令。

重新编写了正确的`set_CANID_cybergear()`函数，修复了CAN帧格式配置问题，成功实现了电机ID修改。新的升降系统直接使用了之前开发的`CyberGear_MoveTo_Trapezoidal_V2()`梯形速度规划函数，运行效果良好，完全消除了步进电机的纹波问题，同时获得了更精确的位置控制和更平滑的运动曲线。
